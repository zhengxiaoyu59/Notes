## TPS和响应时间之间的关系
![图1](https://github.com/zhengxiaoyu59/Notes/blob/master/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/images/021.png?raw=true)  
* 三条曲线：使用率/用户数（Utilization），吞吐量（Throughput），响应时间（Response Time）  
* 三个区域：轻负载区（Light Load），重负载区（Heavy Load），塌陷区（Buckle Zone）  
* 两个点：最优并发用户数（The Optimum Number of Concurrent Users），最大并发用户数（The Maximum Number of Concurrent Users）  
* 三个状态描述：资源饱和（Resource Saturated），吞吐下降（Throughput Falling），用户受影响（End Users Effected）  

图中有些地方可能与实际存在误差：  
* 重负载区的资源饱和 与 TPS达到最大值 不是在同样的并发用户数之下的。  
> e.g.当CPU资源使用率达到100%后，随着压力增加，队列变长。由于用户数的增加幅度会超过队列长度的增加幅度，所以TPS仍会增加。
即，资源使用率达到饱和后，TPS仍会上升然后达到上限。  
（个人理解为，用户增加速度与将用户加入队列的速度不同，队列长度有上限；队列长度增加时，TPS上升，满队列时，TPS达到上限）  
大部分情况下，响应时间曲线不会这么陡峭，也不一定是在塌陷区突然上升，更可能在重负载区突然上升。  

* 吞吐量曲线不一定会出现下降的情况，在有些控制较好的系统中会维持水平。
> 达到最大TPS后，就没必要继续施压了，目标是知道TPS的上限而不是压死。  

* 最优并发数，没有绝对的数据来证明，在生产运维过程中，会在这个点靠前一点作为最优并发。

* 最大并发数，没有道理，性能已经衰退了，最大并发数肯定在更前的位置。
> 更关心TPS（服务端能处理的请求数），而不是压力工具中的线程数。  

*上图没有考虑锁或线程等配置不合理而又常见的场景，也就是TPS上不去，资源用不上。所以此图默认了一个前提，只要线程能用上，资源就会上涨。  

在系统饱和点（Saturation point）之前，性能指标就已经可以显出问题，接着施压是为了让指标更明显，以便作出正确判断。  
“调优”实际上是控制系统在饱和点之前，控制容量到什么样的水位才是性能测试与分析的目标。  


![图2](https://github.com/zhengxiaoyu59/Notes/blob/master/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/images/022.png?raw=true)  
蓝线：TPS  黄线：响应时间RT  

* TPS增加时，RT一开始处于较低状态（A点之前）
* RT开始有些增加，直到业务可以承受的时间点B，这时TPS仍有增长空间
* 继续增加压力，到达C点时，达到最大TPS
* 继续增加压力，RT继续增加，但TPS会下降（非必然，队列处理得好的系统，比如限流、 熔断等保护措施，会保持稳定的TPS，多余的请求会被友好拒绝）
* 最后RT过长，达到超时的程度
> 熔断： 在微服务中，扇出的微服务不可用或者相应时间过长的话会对服务降级，进而熔断该服务节点，快速返回错误信息，释放资源。而当检测到微服务响应正常后，则恢复调用。  
即，服务不可用了，迅速告诉前端出错，不再进行CURD。每个服务都会注册到一个代理里面，每秒会通知代理我还活着呢，一旦宕了就通知不了了，代理那里就自动过期了。流量过来，在入口就知道访问的东西不能用并返回错误。  

## 使用场景的定义替换混乱概念

| 场景 | 作用 | 替换的概念 |
|  ----  | ----  | ----  |
| 基本性能场景 | 也可称为“单交易容量”，即每个业务都压到最大TPS，为后续场景作数据对比 | |
| 容量性能场景 | 也可称为“混合容量性能场景”，即将所有业务按比例加到一个场景中，在数据、软硬件环境、监控等配合下，分析瓶颈并调优的过程 | 性能测试、负载测试、压力测试、强度测试、容量测试、极限测试、性能评测测试、性能调优测试、并发测试、综合场景测试、递增测试、内存泄露测试、数据容量测试、极限测试、配置测试 |
| 稳定性性能场景 | 核心是“时长”。在长时间的运行下，观察系统的性能表现，分析瓶颈并调优的过程 | 疲劳强度测试、稳定性压力测试 |
| 异常性能场景 | 最重要。  常用手段：宕主机、宕应用、宕网卡。随着云基础架构发展，还有宕容器、宕虚机、宕缓存、宕队列、宕集装箱、宕流控、宕熔断等。实际场景中要模拟什么样的异常，一定是根据系统的业务架构和部署架构分析而来，不是看到什么都宕 | 破坏性压力测试 |

在具体场景的操作层面，只有场景中的配置是具体可操作的。通常大家认为的性能测试、负载测试、压力测试在操作的层面，只有压力工具中线程数的区别；其他区别都在资源分析层面。资源分析在场景之后，看作分析的部分，而非测试的部分。  

### e.g. 配置测试和递增测试

在性能中，有很多配置：JVM参数、OS参数、DB参数、网络参数、容器参数等。对于配置参数来说，只是做个简单变更，性能场景没有变化。配置更改前后，会用同样的性能场景来判断效果，最多再增加一些前端压力，实际场景没有任何变化。所以“配置测试”不能作为一个单独分类。  

